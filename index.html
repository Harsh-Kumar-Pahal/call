<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
       html, body {
    /* margin: 0; */
    /* padding: 0; */
    height: 100%; /* Ensures gradient spans the full height */
    background: linear-gradient(to bottom, #000000, #282828); /* Smooth black to gray gradient */
    font-family: Arial, sans-serif;
    text-align: center;
}

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
/* General container styling */
.video-container {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

/* Remote video styling: Fullscreen background */
#remoteVideo {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ensures it covers the full screen */
}

/* Local video styling: Small box in bottom-right corner */
#localVideo {
    position: absolute;
    width: 120px; /* Adjust size as needed */
    height: 90px;
    object-fit: fill;
    bottom: 100px; /* Distance from bottom */
    right: 20px; /* Distance from right */
    border-radius: 8px; /* Optional: Rounded corners */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.5); /* Optional: Shadow */
    z-index: 1000;
}


        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            filter: blur(10%);
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px;
            border-radius: 50px;
            z-index: 1000;
        }
        .control-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #000000;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-button:hover {
            background-color: #444;
        }
        .control-button.active {
            background-color: #c62828;
        }
        
        .setup-container {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            filter: blur(10%);
            background-color: rgba(255, 255, 255, 0.047);
            width: 230px;
            /* border-radius: 10px; */
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        .setup-container input {
            padding: 10px;
            border: 1px solid #ddd;
            /* border-radius: 4px; */
            background-color: #444;
            border: none;
            box-shadow: 1px 2px 1px rgb(0, 0, 0) inset;
            margin-right: 10px;
            width: 207px;
            margin-bottom: 10px;
        }
        .setup-container button {
            padding: 10px 20px;
            border: none;
            width: 111.5px;
            /* border-radius: 4px; */
            box-shadow: 1px -2px 1px rgb(0, 0, 0) inset, -1px -2px 1px rgb(0, 0, 0)inset;
            background-color: #0084ff;
            color: white;
            cursor: pointer;
        }
        .setup-container button :hover{
            box-shadow: none;
        }
        #status {
            color: rgb(255, 200, 0);
            padding: 10px;
            margin-top: 10px;
            /* border-radius: 4px; */
            background-color: #ffc80081;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="setupPanel" class="setup-container">
            <h2 style="color: #ffffff;">Video Call App</h2>
            <div>
                <input type="text" id="roomId" placeholder="Enter Room ID">
                <button id="createButton" style="padding: 10px; background-color: rgba(103, 176, 255, 0.245);color: #0084ff;">Create Room</button>
                <button id="joinButton" style="padding: 10px; background-color: rgba(13, 255, 0, 0.121); color: green;">Join Room</button>
            </div>
            <div id="status">Ready to start a call</div>
            <div id="error" class="error hidden"></div>
        </div>

        

        <div id="callPanel" class="hidden">
            <div class="video-grid">
                <div class="video-container" >
                    <video id="localVideo" autoplay playsinline muted style="object-fit:contain;"></video>
                </div>
                <div class="video-container"  >
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>

        <div id="controls" class="controls hidden">
            <button class="control-button" id="muteButton" title="Mute Audio"><i class="fa-solid fa-microphone fa-xl" style="color: rgb(0, 145, 255);"></i></button>
            <button class="control-button" id="hangupButton" title="End Call"><i class="fa-solid fa-phone fa-xl" style="color: red;"></i></button>
            <button class="control-button" id="videoButton" title="Stop Video"><i class="fa-solid fa-video fa-xl" style="color: rgb(0, 255, 81);"></i></button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDB_ylrW7hartjCjSAqjjZjUoNSrSX7Et4",
            authDomain: "blogs-a7325.firebaseapp.com",
            databaseURL: "https://blogs-a7325-default-rtdb.firebaseio.com",
            projectId: "blogs-a7325",
            storageBucket: "blogs-a7325.appspot.com",
            messagingSenderId: "868013133674",
            appId: "1:868013133674:web:8ceaa7dfa63ee0d2a0df13",
            measurementId: "G-RJX09FKMMY"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        let peerConnection;
        let localStream;
        let roomId;
        let isAudioMuted = false;
        let isVideoOff = false;

        // DOM elements
        const setupPanel = document.getElementById('setupPanel');
        const callPanel = document.getElementById('callPanel');
        const controlsPanel = document.getElementById('controls');
        const createButton = document.getElementById('createButton');
        const joinButton = document.getElementById('joinButton');
        const hangupButton = document.getElementById('hangupButton');
        const muteButton = document.getElementById('muteButton');
        const videoButton = document.getElementById('videoButton');
        const roomIdInput = document.getElementById('roomId');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');

        createButton.addEventListener('click', createRoom);
        joinButton.addEventListener('click', joinRoom);
        hangupButton.addEventListener('click', hangup);
        muteButton.addEventListener('click', toggleAudio);
        videoButton.addEventListener('click', toggleVideo);

        async function createRoom() {
            try {
                roomId = roomIdInput.value || Math.random().toString(36).substring(7);
                roomIdInput.value = roomId;

                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                localVideo.srcObject = localStream;

                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                setupPeerConnection();

                // Add local stream tracks to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Create and set local description
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Save the offer to Firebase
                await database.ref(`rooms/${roomId}/offer`).set({
                    type: offer.type,
                    sdp: offer.sdp
                });

                // Listen for answer
                database.ref(`rooms/${roomId}/answer`).on('value', async snapshot => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    }
                });

                showCallUI();
                updateStatus('Room created! Share the Room ID: ' + roomId);

            } catch (error) {
                showError(`Error creating room: ${error.message}`);
            }
        }

        async function joinRoom() {
            try {
                roomId = roomIdInput.value;
                if (!roomId) {
                    throw new Error('Please enter a room ID');
                }

                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                localVideo.srcObject = localStream;

                // Get the offer from Firebase
                const snapshot = await database.ref(`rooms/${roomId}/offer`).get();
                const offer = snapshot.val();
                if (!offer) {
                    throw new Error('Room not found');
                }

                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                setupPeerConnection();

                // Add local stream tracks to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Set remote description (offer)
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                // Create and set local description (answer)
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Save the answer to Firebase
                await database.ref(`rooms/${roomId}/answer`).set({
                    type: answer.type,
                    sdp: answer.sdp
                });

                showCallUI();
                updateStatus('Connected to room: ' + roomId);

            } catch (error) {
                showError(`Error joining room: ${error.message}`);
            }
        }

        function setupPeerConnection() {
            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    database.ref(`rooms/${roomId}/candidates/${Date.now()}`).set({
                        candidate: event.candidate.toJSON()
                    });
                }
            };

            // Handle remote stream
            peerConnection.ontrack = event => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // Listen for remote ICE candidates
            database.ref(`rooms/${roomId}/candidates`).on('child_added', snapshot => {
                const data = snapshot.val();
                if (data && data.candidate) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            });
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isAudioMuted = !isAudioMuted;
                    audioTrack.enabled = !isAudioMuted;
                    muteButton.innerHTML = isAudioMuted ? `<i class="fa-solid fa-microphone-slash fa-xl" style="color: #ff2e2e;"></i>` : `<i class="fa-solid fa-microphone fa-xl" style="color: rgb(0, 145, 255);"></i>`;
                    muteButton.classList.toggle('active', isAudioMuted);
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoOff = !isVideoOff;
                    videoTrack.enabled = !isVideoOff;
                    videoButton.innerHTML = isVideoOff ? `<i class="fa-solid fa-video-slash fa-xl" style="color: #ff1f1f;"></i>` : `<i class="fa-solid fa-video fa-xl" style="color: #00ff9d;"></i>`;
                    videoButton.classList.toggle('active', isVideoOff);
                }
            }
        }

        function hangup() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            if (peerConnection) {
                peerConnection.close();
            }

            if (roomId) {
                database.ref(`rooms/${roomId}`).remove();
            }

            // Reset variables
            localStream = null;
            peerConnection = null;
            roomId = null;
            isAudioMuted = false;
            isVideoOff = false;

            // Reset UI
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            hideCallUI();
            updateStatus('Call ended');
            roomIdInput.value = '';
        }

        function showCallUI() {
            setupPanel.classList.add('hidden');
            callPanel.classList.remove('hidden');
            controlsPanel.classList.remove('hidden');
        }

        function hideCallUI() {
            setupPanel.classList.remove('hidden');
            callPanel.classList.add('hidden');
            controlsPanel.classList.add('hidden');
        }

        function updateStatus(message) {
            statusDiv.textContent = message;
            errorDiv.classList.add('hidden');
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Clean up when the page is closed
        window.addEventListener('beforeunload', hangup);
    </script>
</body>
</html>
