<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Audio Call</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(130deg, #1a1a1a 0%, #2d3436 100%);
        }
        .controls {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .control-button {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
        }
        .control-button:hover {
            transform: scale(1.1);
        }
        .room-id {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
        }
        #toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen overflow-hidden">
    <div id="roomIdDisplay" class="room-id">
        Room ID: <span id="roomId"></span>
        <button id="copyRoom" class="ml-2 text-blue-400 hover:text-blue-300">
            <i class="fas fa-copy"></i>
        </button>
    </div>

    <div class="controls">
        <button id="joinRoom" class="control-button bg-blue-600 hover:bg-blue-700">
            <i class="fas fa-door-open"></i>
        </button>
        <button id="toggleAudio" class="control-button bg-gray-700 hover:bg-gray-600">
            <i class="fas fa-microphone"></i>
        </button>
        <button id="endCall" class="control-button bg-red-600 hover:bg-red-700">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>

    <div id="toast"></div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDB_ylrW7hartjCjSAqjjZjUoNSrSX7Et4",
            authDomain: "blogs-a7325.firebaseapp.com",
            databaseURL: "https://blogs-a7325-default-rtdb.firebaseio.com",
            projectId: "blogs-a7325",
            storageBucket: "blogs-a7325.appspot.com",
            messagingSenderId: "868013133674",
            appId: "1:868013133674:web:8ceaa7dfa63ee0d2a0df13",
            measurementId: "G-RJX09FKMMY"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        // WebRTC Configuration with TURN servers
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'turn:numb.viagenie.ca', username: 'webrtc@live.com', credential: 'muazkh' },
                { urls: 'turn:turn.anyfirewall.com:443?transport=tcp', username: 'webrtc', credential: 'webrtc' }
            ]
        };

        let peerConnection;
        let localStream;
        let currentRoom;

        const joinRoomBtn = document.getElementById('joinRoom');
        const toggleAudioBtn = document.getElementById('toggleAudio');
        const endCallBtn = document.getElementById('endCall');
        const roomIdDisplay = document.getElementById('roomId');
        const copyRoomBtn = document.getElementById('copyRoom');

        // Toast notification function
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        // Generate random room ID
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 15);
        }

        // Initialize audio stream
        async function initializeStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (error) {
                console.error('Error accessing microphone:', error);
                showToast('Error accessing microphone. Please check permissions.');
            }
        }

        // Create or join room
        async function createOrJoinRoom() {
            try {
                const roomId = prompt('Enter room ID or leave empty to create new room:');
                currentRoom = roomId || generateRoomId();
                roomIdDisplay.textContent = currentRoom;
                
                const roomRef = db.ref(`rooms/${currentRoom}`);
                const roomSnapshot = await roomRef.once('value');
                
                if (roomSnapshot.exists()) {
                    joinRoom(currentRoom);
                } else {
                    createRoom(currentRoom);
                }
            } catch (error) {
                console.error('Error creating/joining room:', error);
                showToast('Error connecting to room. Please try again.');
            }
        }

        // Create new room
        async function createRoom(roomId) {
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            const roomRef = db.ref(`rooms/${roomId}`);
            const offerCandidates = roomRef.child('offerCandidates');
            const answerCandidates = roomRef.child('answerCandidates');

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    offerCandidates.push(JSON.stringify(event.candidate));
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await roomRef.set({ offer: { sdp: offer.sdp, type: offer.type } });

            roomRef.child('answer').on('value', async snapshot => {
                if (snapshot.exists() && snapshot.val().sdp) {
                    const answer = snapshot.val();
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            answerCandidates.on('child_added', async snapshot => {
                try {
                    const candidate = JSON.parse(snapshot.val());
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                }
            });
        }

        // Join existing room
        async function joinRoom(roomId) {
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            const roomRef = db.ref(`rooms/${roomId}`);
            const offerSnapshot = await roomRef.child('offer').once('value');
            const offer = offerSnapshot.val();

            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await roomRef.child('answer').set({ sdp: answer.sdp, type: answer.type });

            roomRef.child('offerCandidates').on('child_added', async snapshot => {
                try {
                    const candidate = JSON.parse(snapshot.val());
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                }
            });

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    roomRef.child('answerCandidates').push(JSON.stringify(event.candidate));
                }
            };
        }

        // Event listeners
        joinRoomBtn.addEventListener('click', createOrJoinRoom);

        toggleAudioBtn.addEventListener('click', () => {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            toggleAudioBtn.innerHTML = audioTrack.enabled
                ? '<i class="fas fa-microphone"></i>'
                : '<i class="fas fa-microphone-slash"></i>';
        });

        endCallBtn.addEventListener('click', () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            showToast('Call ended.');
        });

        copyRoomBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoom);
            showToast('Room ID copied to clipboard.');
        });

        // Initialize stream on page load
        window.onload = initializeStream;
    </script>
</body>
</html>
