<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-container {
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            min-height: 300px;
            object-fit: cover;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 50px;
            z-index: 1000;
        }

        .control-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #333;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-button:hover {
            background-color: #444;
        }

        .control-button.active {
            background-color: #c62828;
        }

        .setup-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .setup-container input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 200px;
        }

        .setup-container button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #0084ff;
            color: white;
            cursor: pointer;
        }

        .setup-container button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            background-color: #e8f5e9;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="setupPanel" class="setup-container">
            <h2>Video Call App</h2>
            <div>
                <input type="text" id="roomId" placeholder="Enter Room ID">
                <button id="createButton">Create Room</button>
                <button id="joinButton">Join Room</button>
            </div>
            <div id="status">Ready to start a call</div>
            <div id="error" class="error hidden"></div>
        </div>

        <div id="callPanel" class="hidden">
            <div class="video-grid">
                <div class="video-container">
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>

        <div id="controls" class="controls hidden">
            <button class="control-button" id="muteButton" title="Mute Audio">ðŸŽ¤</button>
            <button class="control-button" id="videoButton" title="Stop Video">ðŸ“¹</button>
            <button class="control-button" id="screenButton" title="Share Screen">ðŸ’»</button>
            <button class="control-button" id="hangupButton" title="End Call">ðŸ“ž</button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDB_ylrW7hartjCjSAqjjZjUoNSrSX7Et4",
            authDomain: "blogs-a7325.firebaseapp.com",
            databaseURL: "https://blogs-a7325-default-rtdb.firebaseio.com",
            projectId: "blogs-a7325",
            storageBucket: "blogs-a7325.appspot.com",
            messagingSenderId: "868013133674",
            appId: "1:868013133674:web:8ceaa7dfa63ee0d2a0df13",
            measurementId: "G-RJX09FKMMY"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // WebRTC configuration
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
            ]
        };

        // Global variables
        let peerConnection;
        let localStream;
        let screenStream;
        let roomId;
        let isAudioMuted = false;
        let isVideoOff = false;
        let isScreenSharing = false;

        // DOM elements
        const setupPanel = document.getElementById('setupPanel');
        const callPanel = document.getElementById('callPanel');
        const controlsPanel = document.getElementById('controls');
        const createButton = document.getElementById('createButton');
        const joinButton = document.getElementById('joinButton');
        const hangupButton = document.getElementById('hangupButton');
        const muteButton = document.getElementById('muteButton');
        const videoButton = document.getElementById('videoButton');
        const screenButton = document.getElementById('screenButton');
        const roomIdInput = document.getElementById('roomId');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');

        // Event listeners
        createButton.addEventListener('click', createRoom);
        joinButton.addEventListener('click', joinRoom);
        hangupButton.addEventListener('click', hangup);
        muteButton.addEventListener('click', toggleAudio);
        videoButton.addEventListener('click', toggleVideo);
        screenButton.addEventListener('click', toggleScreenSharing);

        async function createRoom() {
            try {
                roomId = roomIdInput.value || Math.random().toString(36).substring(7);
                roomIdInput.value = roomId;
                
                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                localVideo.srcObject = localStream;
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                setupPeerConnection();
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Create and set local description
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Save the offer to Firebase
                await database.ref(`rooms/${roomId}/offer`).set({
                    type: offer.type,
                    sdp: offer.sdp
                });

                showCallUI();
                updateStatus('Room created! Share the Room ID with your friend.');

            } catch (error) {
                showError(`Error creating room: ${error.message}`);
            }
        }

        async function joinRoom() {
            try {
                roomId = roomIdInput.value;
                if (!roomId) {
                    throw new Error('Please enter a room ID');
                }

                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                localVideo.srcObject = localStream;
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(configuration);
                setupPeerConnection();
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Get the offer from Firebase
                const snapshot = await database.ref(`rooms/${roomId}/offer`).get();
                const offer = snapshot.val();
                if (!offer) {
                    throw new Error('Room not found');
                }

                // Set remote description (offer)
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                // Create and set local description (answer)
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Save the answer to Firebase
                await database.ref(`rooms/${roomId}/answer`).set({
                    type: answer.type,
                    sdp: answer.sdp
                });

                showCallUI();
                updateStatus('Connected to the room!');

            } catch (error) {
                showError(`Error joining room: ${error.message}`);
            }
        }

        function setupPeerConnection() {
            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    database.ref(`rooms/${roomId}/candidates`).push({
                        candidate: event.candidate.candidate,
                        sdpMid: event.candidate.sdpMid,
                        sdpMLineIndex: event.candidate.sdpMLineIndex
                    });
                }
            };

            // Listen for remote ICE candidates
            database.ref(`rooms/${roomId}/candidates`).on('child_added', snapshot => {
                const candidate = snapshot.val();
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            });

            // Handle remote stream
            peerConnection.ontrack = event => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // Handle connection state changes
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'disconnected') {
                    hangup();
                }
            };
        }

        async function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isAudioMuted = !isAudioMuted;
                    audioTrack.enabled = !isAudioMuted;
                    muteButton.textContent = isAudioMuted ? 'ðŸ”‡' : 'ðŸŽ¤';
                    muteButton.classList.toggle('active', isAudioMuted);
                }
            }
        }

        async function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoOff = !isVideoOff;
                    videoTrack.enabled = !isVideoOff;
                    videoButton.textContent = isVideoOff ? 'ðŸš«' : 'ðŸ“¹';
                    videoButton.classList.toggle('active', isVideoOff);
                }
            }
        }

        async function toggleScreenSharing() {
            try {
                if (!isScreenSharing) {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const videoTrack = screenStream.getVideoTracks()[0];
                    
                    const senders = peerConnection.getSenders();
                    const sender = senders.find(s => s.track.kind === 'video');
                    await sender.replaceTrack(videoTrack);
                    
                    localVideo.srcObject = screenStream;
                    screenButton.textContent = 'ðŸ”´';
                    screenButton.classList.add('active');
                    isScreenSharing = true;

                    videoTrack.onended = () => {
                        toggleScreenSharing();
                    };
                } else {
                    const videoTrack = localStream.getVideoTracks()[0];
                    const senders = peerConnection.getSenders();
                    const sender = senders.find(s => s.track.kind === 'video');
                    await sender.replaceTrack(videoTrack);
                    
                    localVideo.srcObject = localStream;
                    screenButton.textContent = 'ðŸ’»';
                    screenButton.classList.remove('active');
                    isScreenSharing = false;

                    if (screenStream) {
                        screenStream.getTracks().forEach(track => track.stop());
                        screenStream = null;
                    }
                }
            } catch (error) {
                showError(`Error toggling screen share: ${error.message}`);
            }
        }

        function hangup() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            
            if (peerConnection) {
                peerConnection.close();
            }

            if (roomId) {
                database.ref(`rooms/${roomId}`).remove();
            }

            // Reset variables
            localStream = null;
            screenStream = null;
            peerConnection = null;
            roomId = null;
            isAudioMuted = false;
            isVideoOff = false;
            isScreenSharing = false;

            // Reset UI
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            hideCallUI();
            updateStatus('Call ended');
            roomIdInput.value = '';
        }

        function showCallUI() {
            setupPanel.classList.add('hidden');
            callPanel.classList.remove('hidden');
            controlsPanel.classList.remove('hidden');
        }

        function hideCallUI() {
            setupPanel.classList.remove('hidden');
            callPanel.classList.add('hidden');
            controlsPanel.classList.add('hidden');
        }

        function updateStatus(message) {
            statusDiv.textContent = message;
            errorDiv.classList.add('hidden');
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Clean up when the page is closed
        window.addEventListener('beforeunload', hangup);
    </script>
</body>
